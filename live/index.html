<!DOCTYPE html>
<html>
  <head>
    <link rel="manifest" href="manifest.json" />
    <script src="https://unpkg.com/socket.io-client@4.8.1/dist/socket.io.min.js"></script>
    <meta
      name="Description"
      content="HeatSync Labs. Arizona's greatest hackerspace."
    />
    <style type="text/css">
      body {
        background-color: #2c2c29;
        color: #2c2c29;
        font-family: Tahoma;
        font-size: 11px;
        margin: 0;
        padding: 0;
      }

      .open {
        color: green;
        display: inline;
      }

      .closed {
        color: red;
        display: inline;
      }

      #wrapper {
        width: 85%;
        margin: 0 auto;
      }

      #top span {
        display: none;
      }

      #content {
        background-color: #fff;
        padding: 1em;
        font-size: 1.2em;
      }

      .caption {
        background-color: #f3f3f3;
        border: 1px solid #ddd;
        padding: 4px;
        margin: 0 0 0 30px;
        display: inline-block;
      }

      .footer {
        clear: both;
      }

      h1,
      h2,
      h3,
      h4 {
        font-family: Helvetica, Georgia;
        font-size: 24px;
        letter-spacing: -1px;
        margin: 0px 0px 10px;
        border-bottom: 1px solid #dcdcdb;
      }

      h2 {
        font-size: 22px;
      }

      h3 {
        font-size: 20px;
      }

      h4 {
        font-size: 18px;
      }

      canvas {
        display: block;
        margin: 0 auto;
        width: 100%;
        height: 100%;
      }
    </style>
    <meta name="theme-color" content="#f99b0c" />
  </head>

  <body>
    <div id="wrapper">
      <a href="http://www.heatsynclabs.org">
        <img src="/img/logo-light.png" height="116" />
      </a>

      <div id="content">
        <h2>HeatSync Labs Live Webcams</h2>
        <p>
          See if there are people in the lab! <br />The camera views outlines of people in real time, though you may not be able to tell if
          nothing's moving. <br />
          If the cameras are broken, please email
          operations at heatsynclabs dot org and mention "web cams" in the subject line.
        </p>
        <p>
          Nobody here? Check the
          <a href="http://twitter.com/heatsyncstatus">HeatSyncStatus</a> feed.
          See when the next event is scheduled at the
          <a href="http://www.heatsynclabs.org">HeatSync Website</a>.
        </p>

        <div class="caption">
          <canvas
            id="livestream1"
          />
        </div>

        <div class="caption">
          <canvas
            id="livestream2"
          />
        </div>

        <div class="caption">
          <canvas
            id="livestream3"
          />
        </div>

        <div class="caption">
          <canvas
            id="livestream4"
          />
        </div>
        <ul>
          <li>
            doors currently:
            <span id="door_status">
              <i class="icon-spinner icon-spin"></i>
            </span>
          </li>
        </ul>
      </div>
    </div>
    <script type="module" src="/src/scripts/doors.js"></script>
    <script type="text/javascript">
      const socket = io('https://hsl-cam-reflector-c1bb8fa26eef.herokuapp.com/', {
        transports: ['websocket'],
      });
      const cams = {
        CAM1: {
          image: {
            height: 720,
            width: 1280,
          },
          predictions: [],
        },
        CAM2: {
          image: {
            height: 720,
            width: 1280,
          },
          predictions: [],
        },
        CAM3: {
          image: {
            height: 600,
            width: 800,
          },
          predictions: [],
        },
        CAM4: {
          image: {
            height: 360,
            width: 640,
          },
          predictions: [],
        },
      };

      socket.on('connect', () => {
        console.log('Connected to the camdata server');
      });
      socket.on('disconnect', () => {
        console.log('Disconnected from the camdata server');
      });
      socket.on('camResults', (data) => {
        // console.log('Received camdata:', data);
        if (data.CAM1) {
          cams.CAM1 = data.CAM1;
        }
        if (data.CAM2) {
          cams.CAM2 = data.CAM2;
        }
        if (data.CAM3) {
          cams.CAM3 = data.CAM3;
        }
        if (data.CAM4) {
          cams.CAM4 = data.CAM4;
        }
      });

      const images = Array(4).fill(0).map((c, idx) => {
        const img = new Image();
        img.src = `/img/backgrounds/snapshot${idx + 1}.jpg`;
        img.onload = () => {
          console.log(`img ${idx + 1} loaded`);
        };
        return img;
      });

      const canvases = images.map((c, idx) => {
        return document.getElementById(`livestream${idx + 1}`);
      });

      // offscreen canvases for effects
      const mCanvases = canvases.map(c => {
        return document.createElement("canvas");
      });

      const rainCanvas = document.createElement("canvas");
      rainCanvas.width = 1920;
      rainCanvas.height = 1080;
      class RainChar {
        constructor(font, charSize, chars, bg, fg) {
          // Defining the parameters
          this.font = font;
          this.charSize = charSize;
          this.chars = chars;
          this.bg = bg;
          this.fg = fg;

          // Setting up the canvas
          const canvas = rainCanvas;
          this.context = canvas.getContext("2d");
          this.size = [canvas.width, canvas.height];
          canvas.width = this.size[0];
          canvas.height = this.size[1];

          this.context.fillStyle = this.bg;
          this.context.fillRect(0, 0, ...this.size);

          // Creating the particles array
          this.particles = [];
          const particleCount =
            (this.size[0] * this.size[1]) / this.charSize ** 2 / 10;

          for (let i = 0; i < particleCount; i++) {
            this.particles.push(this.newParticle());
          }
        }

        newParticle() {
          return {
            x: Math.random() * this.size[0],
            y: -Math.random() * this.size[1] * 2,
            size: Math.floor(
              Math.random() * (this.charSize * 2 - this.charSize / 2) +
                this.charSize / 2
            )
          };
        }

        drawParticles() {
          this.context.fillStyle = this.fg;
          this.particles.forEach((particle) => {
            this.context.font = `${particle.size}px ${this.font}`;
            const randomChar = this.chars[
              Math.floor(Math.random() * this.chars.length)
            ];
            this.context.fillText(randomChar, particle.x, particle.y);
          });
        }

        updateParticles() {
          this.particles.forEach((particle) => {
            if (particle.y > this.size[1]) {
              Object.assign(particle, this.newParticle());
            } else {
              particle.y += particle.size;
            }
          });
        }

        clearCanvas() {
          this.context.globalAlpha = 0.25;
          this.context.fillStyle = this.bg;
          this.context.fillRect(0, 0, ...this.size);
          this.context.globalAlpha = 1;
        }

        play() {
          this.clearCanvas();
          this.drawParticles();
          this.updateParticles();
          setTimeout(() => {
            this.play();
          }, 65);
        }
      }

      const chars = "ABCDEFGHアイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲンガギグゲゴザジズゼゾダㄥㄖ尺乇爪　乇卩丂ㄩ爪　ᎶㄖㄖᎶㄥ乇　ﾌ卂卩卂几乇丂乇　ㄒ乇乂ㄒヂヅデドバビブベボパピプペポあいうえおくけこさしすせそたちつてとなにぬねのはひふへむめもやゆよらりるれろわをん一二三四五六七八九十零IJKLMNOPRSTUVWXYZabcdefghijklmonpqrstuvwxyz";
      const rain = new RainChar("monospace", 8, chars, "black", "lime");
      rain.play();

      function animate() {
        canvases.forEach((c, idx) => {
          if (!cams[`CAM${idx + 1}`]?.image) {
            console.log(`img ${idx + 1} not loaded`);
            return;
          }
          const newWidth = cams[`CAM${idx + 1}`].image.width;
          const newHeight = cams[`CAM${idx + 1}`].image.height;
          if (newWidth === 0 || newHeight === 0) {
            console.log(`img ${idx + 1} has zero dimensions`);
            return;
          }

          c.width = newWidth;
          c.height = newHeight;

          const area = c.width * c.height;
          const ctx = c.getContext("2d");
          ctx.drawImage(images[idx], 0, 0, c.width, c.height);
          const camData = cams[`CAM${idx + 1}`];

          const people = camData.predictions.filter(p => {
            const [x, y, w, h] = p.bbox;
            const pArea = w * h;
            return (p.class === 'person') && (p.score > 0.6) && ((pArea / area) < 0.2);
          });

          people.forEach(p => {
            const [x, y, w, h] = p.bbox;
            ctx.strokeStyle = 'orange';
            ctx.lineWidth = 5;
            ctx.strokeRect(x, y, w, h);
            // ctx.fillStyle = 'black';
            // ctx.fillRect(x, y, w, h);
            // crop a section of the matrix rainCanvas to use the rectangle the same position as the person

            ctx.drawImage(rainCanvas, 
              x, y, w, h,
              x, y, w, h
            );

            ctx.fillStyle = 'white';
            const fontSize = h * 0.1;
            ctx.font = `${fontSize}px Arial`;
            ctx.fillText(p.class, x, y + fontSize);
            ctx.fillText((p.score * 100).toFixed(1) + '%', x, y + (fontSize * 2.1));
          });

        });
      
        requestAnimationFrame(animate);
      }

      animate();
      
      document.addEventListener("DOMContentLoaded", () => {
        doors().then(console.log).catch(console.error);
      });

    </script>
  </body>
</html>
